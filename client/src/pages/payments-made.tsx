import { useState, useEffect } from "react";
import { useLocation } from "wouter";
import { cn } from "@/lib/utils";
import { useQuery } from "@tanstack/react-query";
import { Plus, Search, Filter, CreditCard, MoreHorizontal, Trash2, X, Pencil, Mail, Printer, ChevronDown, ArrowUpDown, RefreshCw, Download, Settings } from "lucide-react";
import { usePagination } from "@/hooks/use-pagination";
import { TablePagination } from "@/components/table-pagination";
import { useBranding } from "@/hooks/use-branding";
import { PurchasePDFHeader } from "@/components/purchase-pdf-header";
import { useOrganization } from "@/context/OrganizationContext";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Card, CardContent } from "@/components/ui/card";
import { Checkbox } from "@/components/ui/checkbox";
import { Badge } from "@/components/ui/badge";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import {
  ResizableHandle,
  ResizablePanel,
  ResizablePanelGroup,
} from "@/components/ui/resizable";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuPortal,
  DropdownMenuSubContent,
} from "@/components/ui/dropdown-menu";
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
} from "@/components/ui/alert-dialog";
import { useToast } from "@/hooks/use-toast";


interface BillPayment {
  billId: string;
  billNumber: string;
  billDate: string;
  billAmount: number;
  paymentAmount: number;
}

interface PaymentMade {
  id: string;
  paymentNumber: string;
  vendorId: string;
  vendorName: string;
  vendorGstin?: string;
  vendorAddress?: {
    street?: string;
    city?: string;
    state?: string;
    pincode?: string;
    country?: string;
  };
  paymentAmount: number;
  paymentDate: string;
  paymentMode: string;
  paidThrough?: string;
  depositTo?: string;
  paymentType: string;
  status: string;
  reference?: string;
  billPayments?: Record<string, BillPayment> | BillPayment[];
  sourceOfSupply?: string;
  destinationOfSupply?: string;
  notes?: string;
  unusedAmount?: number;
  createdAt: string;
}

interface Vendor {
  id: string;
  vendorName: string;
  companyName?: string;
  gstin?: string;
  address?: string;
  city?: string;
  state?: string;
  pincode?: string;
  country?: string;
}

// Convert number to words for Indian Rupees
function numberToWords(num: number): string {
  if (num === 0) return "Zero Only";

  const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine", "Ten",
    "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
  const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];

  function convertLessThanOneThousand(n: number): string {
    let result = "";
    if (n >= 100) {
      result += ones[Math.floor(n / 100)] + " Hundred ";
      n %= 100;
    }
    if (n >= 20) {
      result += tens[Math.floor(n / 10)] + " ";
      n %= 10;
    }
    if (n > 0) {
      result += ones[n] + " ";
    }
    return result.trim();
  }

  const crore = Math.floor(num / 10000000);
  num %= 10000000;
  const lakh = Math.floor(num / 100000);
  num %= 100000;
  const thousand = Math.floor(num / 1000);
  num %= 1000;
  const remainder = Math.floor(num);
  const paise = Math.round((num % 1) * 100);

  let result = "Indian Rupee ";
  if (crore > 0) result += convertLessThanOneThousand(crore) + " Crore ";
  if (lakh > 0) result += convertLessThanOneThousand(lakh) + " Lakh ";
  if (thousand > 0) result += convertLessThanOneThousand(thousand) + " Thousand ";
  if (remainder > 0) result += convertLessThanOneThousand(remainder);

  result += " Only";
  return result.trim();
}

// Helper to safely get payment number as string (handles corrupted data)
function getPaymentNumberString(paymentNumber: any): string {
  if (typeof paymentNumber === 'string') {
    return paymentNumber;
  }
  if (paymentNumber && typeof paymentNumber === 'object' && paymentNumber.nextNumber) {
    return paymentNumber.nextNumber;
  }
  return '';
}

export default function PaymentsMade() {
  const [, setLocation] = useLocation();
  const { toast } = useToast();
  const [searchQuery, setSearchQuery] = useState("");
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [paymentToDelete, setPaymentToDelete] = useState<string | null>(null);
  const [selectedPayment, setSelectedPayment] = useState<PaymentMade | null>(null);
  const [isSearchVisible, setIsSearchVisible] = useState(false);

  const { data: paymentsData, isLoading, refetch } = useQuery<{ success: boolean; data: PaymentMade[] }>({
    queryKey: ['/api/payments-made'],
  });

  const { data: vendorsData } = useQuery<{ success: boolean; data: Vendor[] }>({
    queryKey: ['/api/vendors'],
  });

  const { data: branding } = useBranding();
  const { currentOrganization } = useOrganization();

  const payments = paymentsData?.data || [];
  const vendors = vendorsData?.data || [];

  // Deep linking for selected payment
  useEffect(() => {
    const searchParams = new URLSearchParams(window.location.search);
    const paymentId = searchParams.get('id');
    if (paymentId && payments.length > 0) {
      const payment = payments.find(p => p.id === paymentId);
      if (payment) {
        setSelectedPayment(payment);
      }
    }
  }, [payments]);

  const filteredPayments = payments.filter(payment =>
    getPaymentNumberString(payment.paymentNumber).toLowerCase().includes(searchQuery.toLowerCase()) ||
    String(payment.vendorName || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
    String(payment.reference || '').toLowerCase().includes(searchQuery.toLowerCase())
  );

  const { currentPage, totalPages, totalItems, itemsPerPage, paginatedItems, goToPage } = usePagination(filteredPayments, 10);

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-IN', {
      style: 'currency',
      currency: 'INR',
      minimumFractionDigits: 2,
    }).format(amount);
  };

  const formatDate = (dateString: string) => {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' });
  };

  const handleDelete = (id: string) => {
    setPaymentToDelete(id);
    setDeleteDialogOpen(true);
  };

  const confirmDelete = async () => {
    if (!paymentToDelete) return;
    try {
      const response = await fetch(`/api/payments-made/${paymentToDelete}`, { method: 'DELETE' });
      if (response.ok) {
        toast({ title: "Payment deleted successfully" });
        if (selectedPayment?.id === paymentToDelete) {
          setSelectedPayment(null);
        }
        refetch();
      } else {
        toast({ title: "Failed to delete payment", variant: "destructive" });
      }
    } catch (error) {
      toast({ title: "Failed to delete payment", variant: "destructive" });
    } finally {
      setDeleteDialogOpen(false);
      setPaymentToDelete(null);
    }
  };

  const getStatusBadge = (status: string) => {
    switch (status?.toUpperCase()) {
      case 'PAID':
        return <span className="text-green-600 font-medium">PAID</span>;
      case 'DRAFT':
        return <span className="text-slate-500">Draft</span>;
      case 'REFUNDED':
        return <span className="text-red-600 font-medium">REFUNDED</span>;
      default:
        return <span>{status}</span>;
    }
  };

  const getBillNumbers = (payment: PaymentMade) => {
    if (!payment.billPayments) return '-';

    if (Array.isArray(payment.billPayments)) {
      return payment.billPayments.map(bp => bp.billNumber).join(', ') || '-';
    }

    const billNums = Object.values(payment.billPayments).map(bp => bp.billNumber);
    return billNums.length > 0 ? billNums.join(', ') : '-';
  };

  const getBillPaymentsArray = (payment: PaymentMade): BillPayment[] => {
    if (!payment.billPayments) return [];
    if (Array.isArray(payment.billPayments)) return payment.billPayments;
    return Object.values(payment.billPayments);
  };

  const getVendorDetails = (payment: PaymentMade) => {
    const vendor = vendors.find(v => v.id === payment.vendorId);
    return vendor;
  };

  const getPaidThroughLabel = (value?: string) => {
    const options: Record<string, string> = {
      'petty_cash': 'Petty Cash',
      'undeposited_funds': 'Undeposited Funds',
      'cash_on_hand': 'Cash on Hand',
      'bank_account': 'Bank Account',
    };
    return options[value || ''] || value || '-';
  };

  const getPaymentModeLabel = (value?: string) => {
    const options: Record<string, string> = {
      'cash': 'Cash',
      'bank_transfer': 'Bank Transfer',
      'cheque': 'Cheque',
      'credit_card': 'Credit Card',
      'upi': 'UPI',
      'neft': 'NEFT',
      'rtgs': 'RTGS',
      'imps': 'IMPS',
    };
    return options[value || ''] || value || '-';
  };

  const handleRowClick = (payment: PaymentMade) => {
    setSelectedPayment(payment);
  };

  const calculateUnusedAmount = (payment: PaymentMade) => {
    if (payment.unusedAmount !== undefined) return payment.unusedAmount;
    const billPayments = getBillPaymentsArray(payment);
    const usedAmount = billPayments.reduce((sum, bp) => sum + (bp.paymentAmount || 0), 0);
    return Math.max(0, payment.paymentAmount - usedAmount);
  };

  const handlePrint = () => {
    const content = document.getElementById('payment-receipt-content')?.innerHTML;
    if (!content) return;

    const printWindow = window.open('', '_blank');
    if (!printWindow) return;

    printWindow.document.write(`
      <html>
        <head>
          <title>Payment Receipt - ${getPaymentNumberString(selectedPayment?.paymentNumber)}</title>
          <script src="https://cdn.tailwindcss.com"></script>
          <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
            body { 
              font-family: 'Inter', sans-serif;
              -webkit-print-color-adjust: exact;
              print-color-adjust: exact;
              background-color: white !important;
            }
            @media print {
              @page { margin: 10mm; }
              body { margin: 0; padding: 0; }
              .no-print { display: none !important; }
              #payment-receipt-content { 
                border: none !important; 
                box-shadow: none !important; 
                width: 100% !important; 
                max-width: none !important;
                padding: 0 !important;
                margin: 0 !important;
              }
              /* Hide the Paid badge during print */
              .paid-badge-overlay {
                display: none !important;
              }
            }
            /* Fix for oklch in tailwind cdn */
            * {
              --tw-ring-color: transparent !important;
              --tw-ring-offset-color: transparent !important;
              --tw-ring-shadow: none !important;
              --tw-shadow: none !important;
              --tw-shadow-colored: none !important;
            }
          </style>
        </head>
        <body class="bg-white">
          <div id="payment-receipt-content" class="w-full">
            ${content}
          </div>
          <script>
            window.onload = () => {
              setTimeout(() => {
                window.print();
                window.close();
              }, 500);
            }
          </script>
        </body>
      </html>
    `);
    printWindow.document.close();
  };

  const handleDownloadPDF = async () => {
    if (!selectedPayment) return;

    const element = document.getElementById('payment-receipt-content');
    if (!element) return;

    try {
      const html2canvas = (await import('html2canvas')).default;
      const { jsPDF } = await import('jspdf');

      // Create a style element for polyfills to remove oklch variables site-wide
      const polyfillStyles = document.createElement('style');
      polyfillStyles.innerHTML = `
        * {
          --tw-ring-color: transparent !important;
          --tw-ring-offset-color: transparent !important;
          --tw-ring-shadow: none !important;
          --tw-shadow: none !important;
          --tw-shadow-colored: none !important;
          outline-color: transparent !important;
          caret-color: transparent !important;
          accent-color: transparent !important;
          
          /* Force standard RGB colors for PDF consistency */
          color-scheme: light !important;
        }
        /* Fix for light lines and colors in PDF */
        .border-slate-50 { border-color: #f1f5f9 !important; border-bottom-width: 1px !important; }
        .border-slate-100 { border-color: #f1f5f9 !important; border-bottom-width: 1px !important; }
        .border-slate-200 { border-color: #e2e8f0 !important; border-bottom-width: 1px !important; }
        .text-slate-400 { color: #94a3b8 !important; }
        .text-slate-500 { color: #64748b !important; }
        .text-slate-600 { color: #475569 !important; }
        .text-slate-700 { color: #334155 !important; }
        .bg-slate-50 { background-color: #f8fafc !important; }
        .bg-slate-100 { background-color: #f1f5f9 !important; }
        
        /* Force background visibility */
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
        
        /* Hide badge for PDF generation */
        .paid-badge-overlay {
          display: none !important;
        }
      `;
      document.head.appendChild(polyfillStyles);

      // Force a re-layout and wait a bit
      await new Promise(resolve => setTimeout(resolve, 100));

      const canvas = await html2canvas(element, {
        scale: 2,
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        onclone: (clonedDoc) => {
          const clonedElement = clonedDoc.getElementById('payment-receipt-content');
          if (clonedElement) {
            // Hide the badge in the clone
            const badge = clonedElement.querySelector('.paid-badge-overlay');
            if (badge) (badge as HTMLElement).style.display = 'none';

            // Find ALL elements in the cloned document
            const allElements = clonedDoc.querySelectorAll('*');
            allElements.forEach((el) => {
              const htmlEl = el as HTMLElement;

              // 1. Clear any inline styles that might use oklch
              const inlineStyle = htmlEl.getAttribute('style') || '';
              if (inlineStyle.includes('oklch')) {
                htmlEl.setAttribute('style', inlineStyle.replace(/oklch\([^)]+\)/g, 'inherit'));
              }

              // 2. Clear known Tailwind 4 variables that often hold oklch
              htmlEl.style.setProperty('--tw-ring-color', 'transparent', 'important');
              htmlEl.style.setProperty('--tw-ring-offset-color', 'transparent', 'important');
              htmlEl.style.setProperty('--tw-ring-shadow', 'none', 'important');
              htmlEl.style.setProperty('--tw-shadow', 'none', 'important');
              htmlEl.style.setProperty('--tw-shadow-colored', 'none', 'important');

              // 3. Force computed styles to fall back
              const computed = window.getComputedStyle(htmlEl);

              // Check all potential color properties
              const colorProps = ['color', 'backgroundColor', 'borderColor', 'outlineColor', 'fill', 'stroke', 'stopColor', 'floodColor', 'lightingColor'];
              colorProps.forEach(prop => {
                const value = computed[prop as any];
                if (value && value.includes('oklch')) {
                  // Standard fallbacks
                  if (prop === 'color') htmlEl.style.setProperty('color', '#0f172a', 'important');
                  else if (prop === 'backgroundColor') htmlEl.style.setProperty('background-color', 'transparent', 'important');
                  else if (prop === 'borderColor') htmlEl.style.setProperty('border-color', '#e2e8f0', 'important');
                  else htmlEl.style.setProperty(prop, 'inherit', 'important');
                }
              });
            });
          }
        }
      });

      document.head.removeChild(polyfillStyles);

      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save(`Payment-${getPaymentNumberString(selectedPayment.paymentNumber)}.pdf`);

      toast({ title: "PDF downloaded successfully" });
    } catch (error) {
      console.error('PDF Generation Error:', error);
      toast({ title: "Failed to download PDF", variant: "destructive" });
    }
  };

  const [isCompact, setIsCompact] = useState(false);

  useEffect(() => {
    const checkCompact = () => {
      setIsCompact(window.innerWidth < 1280);
    };

    checkCompact();
    window.addEventListener('resize', checkCompact);
    return () => window.removeEventListener('resize', checkCompact);
  }, []);

  return (
    <div className="flex h-screen w-full overflow-hidden bg-slate-50">
      <ResizablePanelGroup key={`${selectedPayment ? "split" : "single"}-${isCompact ? "compact" : "full"}`} direction="horizontal" className="h-full w-full">
        {(!isCompact || !selectedPayment) && (
          <ResizablePanel
            defaultSize={isCompact ? 100 : (selectedPayment ? 33 : 100)}
            minSize={isCompact ? 100 : (selectedPayment ? 33 : 100)}
            maxSize={isCompact ? 100 : (selectedPayment ? 33 : 100)}
            className="flex flex-col overflow-hidden bg-white border-r min-w-[25%]"
          >
            {/* Main List View */}
            <div className={`flex flex-col h-full ${selectedPayment ? 'w-full' : 'max-w-full mx-auto p-6'} animate-in fade-in duration-500`}>
              <div className="flex items-center justify-between p-4 border-b border-slate-200 bg-white sticky top-0 z-10 min-h-[73px] h-auto">
                <div className="flex items-center gap-4 flex-1 overflow-hidden">
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="ghost" className="gap-1 font-bold text-slate-900 transition-all p-0 hover:bg-transparent text-left whitespace-normal h-auto">
                        <span className={cn(
                          "transition-all line-clamp-2",
                          selectedPayment ? "text-lg lg:text-xl" : "text-xl"
                        )}>
                          All Payments
                        </span>
                        <ChevronDown className="h-4 w-4 text-slate-500 shrink-0" />
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="start" className="w-56">
                      <DropdownMenuItem className="font-medium">All Payments</DropdownMenuItem>
                      <DropdownMenuItem>Paid</DropdownMenuItem>
                      <DropdownMenuItem>Refunded</DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </div>

                <div className="flex items-center gap-2">
                  {selectedPayment ? (
                    isSearchVisible ? (
                      <div className="relative w-full max-w-[200px] animate-in slide-in-from-right-5 fade-in-0 duration-200">
                        <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                        <Input
                          autoFocus
                          placeholder="Search..."
                          value={searchQuery}
                          onChange={(e) => setSearchQuery(e.target.value)}
                          onBlur={() => !searchQuery && setIsSearchVisible(false)}
                          className="pl-9 h-9"
                        />
                      </div>
                    ) : (
                      <Button
                        variant="outline"
                        size="icon"
                        className="h-9 w-9 px-0"
                        data-testid="button-search-compact"
                        onClick={() => setIsSearchVisible(true)}
                      >
                        <Search className="h-4 w-4 text-slate-500" />
                      </Button>
                    )
                  ) : (
                    <div className="relative w-[240px] hidden sm:block">
                      <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400" />
                      <Input
                        placeholder="Search payments..."
                        value={searchQuery}
                        onChange={(e) => setSearchQuery(e.target.value)}
                        className="pl-9 h-9"
                        data-testid="input-search-payments"
                      />
                    </div>
                  )}
                  <Button
                    className={cn(
                      "bg-blue-600 hover:bg-blue-700 gap-1.5 h-9 font-semibold",
                      selectedPayment && "w-9 px-0"
                    )}
                    size={selectedPayment ? "icon" : "default"}
                    onClick={() => setLocation('/payments-made/new')}
                    data-testid="button-record-payment"
                  >
                    <Plus className="h-4 w-4" />
                    {!selectedPayment && <span>New</span>}
                  </Button>
                  <DropdownMenu>
                    <DropdownMenuTrigger asChild>
                      <Button variant="outline" size="icon" className="h-9 w-9" data-testid="button-more-options">
                        <MoreHorizontal className="h-4 w-4" />
                      </Button>
                    </DropdownMenuTrigger>
                    <DropdownMenuContent align="end" className="w-56 p-1">
                      <DropdownMenuSub>
                        <DropdownMenuSubTrigger>
                          <ArrowUpDown className="mr-2 h-4 w-4" />
                          <span>Sort by</span>
                        </DropdownMenuSubTrigger>
                        <DropdownMenuPortal>
                          <DropdownMenuSubContent>
                            <DropdownMenuItem>Date</DropdownMenuItem>
                            <DropdownMenuItem>Payment Number</DropdownMenuItem>
                            <DropdownMenuItem>Vendor Name</DropdownMenuItem>
                            <DropdownMenuItem>Amount</DropdownMenuItem>
                          </DropdownMenuSubContent>
                        </DropdownMenuPortal>
                      </DropdownMenuSub>
                      <DropdownMenuSeparator />
                      <DropdownMenuItem data-testid="menu-import">
                        <Download className="mr-2 h-4 w-4" /> Import Payments
                      </DropdownMenuItem>
                      <DropdownMenuItem data-testid="menu-export">
                        <Download className="mr-2 h-4 w-4" /> Export Payments
                      </DropdownMenuItem>
                      <DropdownMenuSeparator />
                      <DropdownMenuItem data-testid="menu-preferences">
                        <Settings className="mr-2 h-4 w-4" /> Preferences
                      </DropdownMenuItem>
                      {/* @ts-ignore - refetch is available from useQuery but might not be in types */}
                      <DropdownMenuItem onClick={() => { }}>
                        <RefreshCw className="mr-2 h-4 w-4" /> Refresh List
                      </DropdownMenuItem>
                    </DropdownMenuContent>
                  </DropdownMenu>
                </div>
              </div>

              {isLoading ? (
                <div className="flex items-center justify-center py-16">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                </div>
              ) : payments.length === 0 ? (
                <Card className="border-dashed m-6">
                  <CardContent className="flex flex-col items-center justify-center py-16 text-center">
                    <div className="h-16 w-16 rounded-full bg-muted flex items-center justify-center mb-4">
                      <CreditCard className="h-8 w-8 text-muted-foreground" />
                    </div>
                    <h3 className="text-lg font-semibold mb-2" data-testid="text-payments-empty">No payments recorded</h3>
                    <p className="text-muted-foreground mb-4 max-w-sm">
                      Record payments made to vendors to keep track of your accounts payable.
                    </p>
                    <Button
                      className="gap-2 bg-blue-600 hover:bg-blue-700"
                      onClick={() => setLocation('/payments-made/new')}
                      data-testid="button-record-first-payment"
                    >
                      <Plus className="h-4 w-4" /> Record Your First Payment
                    </Button>
                  </CardContent>
                </Card>
              ) : selectedPayment ? (
                <div className="flex-1 overflow-y-auto scrollbar-hide">
                  <div className="divide-y divide-slate-100">
                    {filteredPayments.map((payment) => (
                      <div
                        key={payment.id}
                        className={`p-4 cursor-pointer transition-colors hover:bg-slate-50 ${selectedPayment.id === payment.id ? 'bg-blue-50 border-l-2 border-l-blue-600' : ''
                          }`}
                        onClick={() => setSelectedPayment(payment)}
                      >
                        <div className="flex items-start justify-between gap-3">
                          <div className="flex gap-3 min-w-0">
                            <Checkbox
                              className="mt-1"
                              onClick={(e) => e.stopPropagation()}
                            />
                            <div className="min-w-0">
                              <div className="font-semibold text-sm truncate uppercase text-slate-900">
                                {payment.vendorName}
                              </div>
                              <div className="text-xs text-slate-500 mt-1">
                                {formatDate(payment.paymentDate)} â€¢ {getPaymentModeLabel(payment.paymentMode)}
                              </div>
                              <div className={`text-[10px] font-bold mt-1 uppercase ${payment.status === 'PAID' ? 'text-green-600' : 'text-slate-400'
                                }`}>
                                {payment.status}
                              </div>
                            </div>
                          </div>
                          <div className="text-right shrink-0">
                            <div className="font-semibold text-sm">
                              {formatCurrency(payment.paymentAmount)}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div className="flex-1 flex flex-col min-h-0">
                  <div className="flex-1 overflow-auto scrollbar-hide">
                    <div className="border rounded-lg overflow-hidden bg-white dark:bg-slate-900 mb-6">
                      <div className="overflow-x-auto">
                        <table className="w-full">
                          <thead className="bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700">
                            <tr>
                              <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-10">
                                <Checkbox
                                  checked={paginatedItems.length > 0 && paginatedItems.every(p => false)} // Logic for bulk select if needed
                                  data-testid="checkbox-select-all"
                                />
                              </th>
                              <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Date</th>
                              <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Payment #</th>
                              <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Reference#</th>
                              <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Vendor Name</th>
                              <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Bill#</th>
                              <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Mode</th>
                              <th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Status</th>
                              <th className="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Amount</th>
                              <th className="px-4 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider whitespace-nowrap">Unused Amount</th>
                              <th className="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider w-10">
                                <Search className="h-4 w-4 mx-auto" />
                              </th>
                            </tr>
                          </thead>
                          <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                            {paginatedItems.map((payment) => (
                              <tr
                                key={payment.id}
                                className={`hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer transition-colors ${selectedPayment?.id === payment.id ? 'bg-blue-50 dark:bg-blue-900/20' : ''}`}
                                onClick={() => handleRowClick(payment)}
                                data-testid={`row-payment-${payment.id}`}
                              >
                                <td className="px-4 py-4" onClick={(e) => e.stopPropagation()}>
                                  <Checkbox data-testid={`checkbox-payment-${payment.id}`} />
                                </td>
                                <td className="px-4 py-4 text-sm text-slate-600 dark:text-slate-300 whitespace-nowrap">{formatDate(payment.paymentDate)}</td>
                                <td className="px-4 py-4 text-sm font-medium text-blue-600 hover:underline whitespace-nowrap">{getPaymentNumberString(payment.paymentNumber)}</td>
                                <td className="px-4 py-4 text-sm text-slate-500 dark:text-slate-400 whitespace-nowrap">{payment.reference || '-'}</td>
                                <td className="px-4 py-4 text-sm font-medium text-slate-900 dark:text-white whitespace-nowrap">{payment.vendorName}</td>
                                <td className="px-4 py-4 text-sm text-slate-600 dark:text-slate-300 whitespace-nowrap">{getBillNumbers(payment)}</td>
                                <td className="px-4 py-4 text-sm capitalize text-slate-600 dark:text-slate-300 whitespace-nowrap">{getPaymentModeLabel(payment.paymentMode)}</td>
                                <td className="px-4 py-4 text-sm whitespace-nowrap">{getStatusBadge(payment.status)}</td>
                                <td className="px-4 py-4 text-sm text-right font-semibold text-slate-900 dark:text-white whitespace-nowrap">
                                  {formatCurrency(payment.paymentAmount)}
                                </td>
                                <td className="px-4 py-4 text-sm text-right text-slate-600 dark:text-slate-300 whitespace-nowrap">
                                  {formatCurrency(calculateUnusedAmount(payment))}
                                </td>
                                <td className="px-4 py-4 text-center" onClick={(e) => e.stopPropagation()}>
                                  <DropdownMenu>
                                    <DropdownMenuTrigger asChild>
                                      <Button variant="ghost" size="icon" className="h-8 w-8 hover-elevate" data-testid={`button-payment-actions-${payment.id}`}>
                                        <MoreHorizontal className="h-4 w-4" />
                                      </Button>
                                    </DropdownMenuTrigger>
                                    <DropdownMenuContent align="end">
                                      <DropdownMenuItem onClick={() => handleRowClick(payment)} data-testid={`action-view-${payment.id}`}>View</DropdownMenuItem>
                                      <DropdownMenuItem onClick={() => setLocation(`/payments-made/edit/${payment.id}`)} data-testid={`action-edit-${payment.id}`}>Edit</DropdownMenuItem>
                                      <DropdownMenuSeparator />
                                      <DropdownMenuItem
                                        className="text-destructive"
                                        onClick={() => handleDelete(payment.id)}
                                        data-testid={`action-delete-${payment.id}`}
                                      >
                                        <Trash2 className="mr-2 h-4 w-4" />
                                        Delete
                                      </DropdownMenuItem>
                                    </DropdownMenuContent>
                                  </DropdownMenu>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  {filteredPayments.length > 0 && (
                    <div className="flex-none border-t border-slate-200 bg-white">
                      <TablePagination
                        currentPage={currentPage}
                        totalPages={totalPages}
                        totalItems={totalItems}
                        itemsPerPage={itemsPerPage}
                        onPageChange={goToPage}
                      />
                    </div>
                  )}
                </div>
              )}
            </div>
          </ResizablePanel>
        )}

        {selectedPayment && (
          <>
            {!isCompact && (
              <ResizableHandle withHandle className="w-1 bg-slate-100 hover:bg-blue-400 hover:w-1.5 transition-all cursor-col-resize" />
            )}
            <ResizablePanel defaultSize={isCompact ? 100 : 65} minSize={isCompact ? 100 : 30} className="bg-white">
              <div className="flex flex-col h-full overflow-hidden">
                {/* Detail Header */}
                <div className="flex items-center justify-between p-3 border-b bg-white">
                  <div className="flex items-center gap-4">
                    <div className="text-xl font-bold">{getPaymentNumberString(selectedPayment.paymentNumber)}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Button variant="outline" size="sm" className="gap-1 h-8" onClick={() => setLocation(`/payments-made/edit/${selectedPayment.id}`)}>
                      <Pencil className="h-3.5 w-3.5" /> Edit
                    </Button>
                    <Button variant="outline" size="sm" className="gap-1 h-8">
                      <Mail className="h-3.5 w-3.5" /> Send Email
                    </Button>
                    <DropdownMenu>
                      <DropdownMenuTrigger asChild>
                        <Button variant="outline" size="sm" className="gap-1 h-8">
                          <Printer className="h-3.5 w-3.5" /> PDF/Print <ChevronDown className="h-3 w-3" />
                        </Button>
                      </DropdownMenuTrigger>
                      <DropdownMenuContent>
                        <DropdownMenuItem onClick={handlePrint}>Print</DropdownMenuItem>
                        <DropdownMenuItem onClick={handleDownloadPDF}>Download PDF</DropdownMenuItem>
                      </DropdownMenuContent>
                    </DropdownMenu>
                    <div className="w-px h-4 bg-slate-200 mx-1" />
                    <Button variant="ghost" size="icon" className="h-8 w-8">
                      <MoreHorizontal className="h-4 w-4" />
                    </Button>
                    <Button variant="ghost" size="icon" className="h-8 w-8" onClick={() => setSelectedPayment(null)}>
                      <X className="h-4 w-4" />
                    </Button>
                  </div>
                </div>

                {/* Detail Content */}
                <div className="flex-1 overflow-y-auto scrollbar-hide p-6 bg-slate-50 dark:bg-slate-950">
                  {/* Receipt Preview */}
                  <div id="payment-receipt-content" className="bg-white dark:bg-slate-900 border shadow-lg mx-auto w-full max-w-[210mm] relative p-8 md:p-12 text-slate-800 dark:text-slate-200 rounded-sm">
                    {/* Paid Badge Overlay */}
                    <div className="absolute top-0 left-0 w-32 h-32 overflow-hidden pointer-events-none paid-badge-overlay">
                      <div className="bg-[#4CAF50] text-white text-[10px] font-bold py-1 px-10 absolute top-4 -left-8 -rotate-45 shadow-sm uppercase tracking-wider">
                        Paid
                      </div>
                    </div>

                    {/* Header with Organization Info */}
                    <div style={{ marginBottom: '40px' }}>
                      <PurchasePDFHeader
                        organization={currentOrganization}
                        logo={branding?.logo}
                        documentTitle="PAYMENT MADE"
                        documentNumber={getPaymentNumberString(selectedPayment.paymentNumber)}
                        date={selectedPayment.paymentDate}
                        referenceNumber={selectedPayment.reference}
                      />
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12 mb-10" style={{ display: 'grid', marginBottom: '40px' }}>
                      <div style={{ borderLeft: '3px solid #f1f5f9', paddingLeft: '20px' }}>
                        <h4 style={{ fontSize: '11px', fontWeight: '800', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '12px', margin: '0' }}>
                          PAID TO
                        </h4>
                        <p style={{ fontSize: '18px', fontWeight: '900', color: '#0f172a', marginBottom: '6px', margin: '0 0 6px 0', letterSpacing: '-0.02em' }}>
                          {selectedPayment.vendorName}
                        </p>
                        <div style={{ fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                          {selectedPayment.vendorAddress?.street && <p style={{ margin: 0 }}>{selectedPayment.vendorAddress.street}</p>}
                          {selectedPayment.vendorAddress?.city && <p style={{ margin: 0 }}>{selectedPayment.vendorAddress.city}</p>}
                          <p style={{ margin: 0 }}>{selectedPayment.vendorAddress?.pincode || '411057'}, {selectedPayment.vendorAddress?.state || 'Maharashtra'}</p>
                          {selectedPayment.vendorGstin && <p style={{ margin: '4px 0 0 0', fontWeight: '600', color: '#991b1b' }}>GSTIN: {selectedPayment.vendorGstin}</p>}
                        </div>
                      </div>
                      <div className="md:border-l-0 border-l-[3px] border-[#f1f5f9] md:pl-0 pl-5">
                        <h4 style={{ fontSize: '11px', fontWeight: '800', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '12px', margin: '0' }}>
                          PAID FROM
                        </h4>
                        <p style={{ fontSize: '18px', fontWeight: '900', color: '#0f172a', marginBottom: '6px', margin: '0 0 6px 0', letterSpacing: '-0.02em' }}>
                          {currentOrganization?.name || 'Your Company'}
                        </p>
                        <div style={{ fontSize: '13px', color: '#475569', lineHeight: '1.6' }}>
                          <p style={{ margin: '0' }}>{currentOrganization?.street1 || ''} {currentOrganization?.city || ''}</p>
                        </div>
                      </div>
                    </div>

                    {/* Metadata Information Bar */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-[1px] mb-10 bg-slate-100 rounded-lg overflow-hidden border border-slate-100" style={{
                      marginBottom: '40px',
                      backgroundColor: '#f1f5f9',
                      border: '1px solid #f1f5f9'
                    }}>
                      <div style={{ backgroundColor: '#ffffff', padding: '16px' }}>
                        <p style={{ fontSize: '10px', fontWeight: '700', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.05em', margin: '0 0 4px 0' }}>Payment Date</p>
                        <p style={{ fontSize: '13px', fontWeight: '800', color: '#0f172a', margin: '0' }}>{formatDate(selectedPayment.paymentDate)}</p>
                      </div>
                      <div style={{ backgroundColor: '#ffffff', padding: '16px' }}>
                        <p style={{ fontSize: '10px', fontWeight: '700', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.05em', margin: '0 0 4px 0' }}>Reference#</p>
                        <p style={{ fontSize: '13px', fontWeight: '800', color: '#0f172a', margin: '0' }}>{selectedPayment.reference || '-'}</p>
                      </div>
                      <div style={{ backgroundColor: '#ffffff', padding: '16px' }}>
                        <p style={{ fontSize: '10px', fontWeight: '700', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.05em', margin: '0 0 4px 0' }}>Payment Mode</p>
                        <p style={{ fontSize: '13px', fontWeight: '800', color: '#0f172a', margin: '0', textTransform: 'uppercase' }}>{getPaymentModeLabel(selectedPayment.paymentMode)}</p>
                      </div>
                      <div style={{ backgroundColor: '#ffffff', padding: '16px', borderLeft: '2px solid #f1f5f9' }}>
                        <p style={{ fontSize: '10px', fontWeight: '700', color: '#b91c1c', textTransform: 'uppercase', letterSpacing: '0.05em', margin: '0 0 4px 0' }}>Amount Paid</p>
                        <p style={{ fontSize: '16px', fontWeight: '900', color: '#b91c1c', margin: '0' }}>{formatCurrency(selectedPayment.paymentAmount)}</p>
                      </div>
                    </div>

                    <div style={{ marginBottom: '24px' }}>
                      <p style={{ fontSize: '10px', fontWeight: '700', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.05em', margin: '0 0 4px 0' }}>Amount in Words</p>
                      <p style={{ fontSize: '13px', fontWeight: '700', color: '#0f172a', fontStyle: 'italic', margin: '0' }}>{numberToWords(selectedPayment.paymentAmount)}</p>
                    </div>

                    {/* Bill Details Table */}
                    {getBillPaymentsArray(selectedPayment).length > 0 && (
                      <div style={{ marginTop: '48px', overflowX: 'auto' }}>
                        <h4 style={{ fontSize: '11px', fontWeight: '800', color: '#64748b', textTransform: 'uppercase', letterSpacing: '0.1em', marginBottom: '16px', margin: '0 0 16px 0' }}>
                          Payment for
                        </h4>
                        <table style={{ width: '100%', borderCollapse: 'collapse', textAlign: 'left', minWidth: '500px' }}>
                          <thead>
                            <tr style={{ backgroundColor: '#991b1b', color: '#ffffff' }}>
                              <th style={{ padding: '12px 16px', fontSize: '11px', fontWeight: '800', textTransform: 'uppercase', letterSpacing: '0.05em', borderRadius: '4px 0 0 0' }}>Bill Number</th>
                              <th style={{ padding: '12px 16px', fontSize: '11px', fontWeight: '800', textTransform: 'uppercase', letterSpacing: '0.05em' }}>Bill Date</th>
                              <th style={{ padding: '12px 16px', fontSize: '11px', fontWeight: '800', textTransform: 'uppercase', letterSpacing: '0.05em', textAlign: 'right' }}>Bill Amount</th>
                              <th style={{ padding: '12px 16px', fontSize: '11px', fontWeight: '800', textTransform: 'uppercase', letterSpacing: '0.05em', textAlign: 'right', borderRadius: '0 4px 0 0' }}>Payment Amount</th>
                            </tr>
                          </thead>
                          <tbody>
                            {getBillPaymentsArray(selectedPayment).map((bp, index) => (
                              <tr key={index} style={{ borderBottom: '1px solid #f1f5f9' }}>
                                <td style={{ padding: '12px 16px', fontSize: '13px', fontWeight: '700', color: '#991b1b' }}>{bp.billNumber}</td>
                                <td style={{ padding: '12px 16px', fontSize: '13px', color: '#475569' }}>{formatDate(bp.billDate)}</td>
                                <td style={{ padding: '12px 16px', fontSize: '13px', color: '#475569', textAlign: 'right' }}>{formatCurrency(bp.billAmount)}</td>
                                <td style={{ padding: '12px 16px', fontSize: '13px', fontWeight: '800', color: '#0f172a', textAlign: 'right' }}>{formatCurrency(bp.paymentAmount || 0)}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    )}
                  </div>

                  {/* Journal Section */}
                  <div className="mt-8 max-w-[800px] mx-auto">
                    <Tabs defaultValue="journal">
                      <TabsList className="h-auto p-0 bg-transparent gap-6">
                        <TabsTrigger
                          value="journal"
                          className="rounded-none border-b-2 border-transparent data-[state=active]:border-blue-600 data-[state=active]:text-blue-600 data-[state=active]:bg-transparent data-[state=active]:shadow-none shadow-none focus-visible:ring-0 focus-visible:ring-offset-0 px-2 py-3 bg-transparent hover:bg-transparent transition-none"
                        >
                          Journal
                        </TabsTrigger>
                      </TabsList>
                      <TabsContent value="journal" className="mt-4">
                        <div className="border rounded-lg p-4 bg-slate-50 dark:bg-slate-800">
                          <div className="flex items-center justify-between mb-4">
                            <div className="text-sm text-muted-foreground">
                              Amount is displayed in your base currency <Badge variant="secondary" className="ml-2">INR</Badge>
                            </div>
                            <div className="flex gap-2">
                              <Button variant="outline" size="sm">Accrual</Button>
                              <Button variant="ghost" size="sm">Cash</Button>
                            </div>
                          </div>

                          <div className="font-semibold mb-2">Vendor Payment - {getPaymentNumberString(selectedPayment.paymentNumber)}</div>
                          <table className="w-full text-sm">
                            <thead className="bg-slate-100 dark:bg-slate-700">
                              <tr>
                                <th className="px-3 py-2 text-left">ACCOUNT</th>
                                <th className="px-3 py-2 text-right">DEBIT</th>
                                <th className="px-3 py-2 text-right">CREDIT</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr className="border-b">
                                <td className="px-3 py-2">{getPaidThroughLabel(selectedPayment.paidThrough)}</td>
                                <td className="px-3 py-2 text-right">0.00</td>
                                <td className="px-3 py-2 text-right">{selectedPayment.paymentAmount.toFixed(2)}</td>
                              </tr>
                              <tr className="border-b">
                                <td className="px-3 py-2">Prepaid Expenses</td>
                                <td className="px-3 py-2 text-right">{selectedPayment.paymentAmount.toFixed(2)}</td>
                                <td className="px-3 py-2 text-right">0.00</td>
                              </tr>
                              <tr className="font-bold bg-slate-100 dark:bg-slate-700">
                                <td className="px-3 py-2"></td>
                                <td className="px-3 py-2 text-right">{selectedPayment.paymentAmount.toFixed(2)}</td>
                                <td className="px-3 py-2 text-right">{selectedPayment.paymentAmount.toFixed(2)}</td>
                              </tr>
                            </tbody>
                          </table>

                          {getBillPaymentsArray(selectedPayment).length > 0 && (
                            <>
                              <div className="font-semibold mb-2 mt-6">Payments Made - {getBillNumbers(selectedPayment)}</div>
                              <table className="w-full text-sm">
                                <thead className="bg-slate-100 dark:bg-slate-700">
                                  <tr>
                                    <th className="px-3 py-2 text-left">ACCOUNT</th>
                                    <th className="px-3 py-2 text-right">DEBIT</th>
                                    <th className="px-3 py-2 text-right">CREDIT</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr className="border-b">
                                    <td className="px-3 py-2">Prepaid Expenses</td>
                                    <td className="px-3 py-2 text-right">0.00</td>
                                    <td className="px-3 py-2 text-right">{selectedPayment.paymentAmount.toFixed(2)}</td>
                                  </tr>
                                  <tr className="border-b">
                                    <td className="px-3 py-2">Accounts Payable</td>
                                    <td className="px-3 py-2 text-right">{selectedPayment.paymentAmount.toFixed(2)}</td>
                                    <td className="px-3 py-2 text-right">0.00</td>
                                  </tr>
                                  <tr className="font-bold bg-slate-100 dark:bg-slate-700">
                                    <td className="px-3 py-2"></td>
                                    <td className="px-3 py-2 text-right">{selectedPayment.paymentAmount.toFixed(2)}</td>
                                    <td className="px-3 py-2 text-right">{selectedPayment.paymentAmount.toFixed(2)}</td>
                                  </tr>
                                </tbody>
                              </table>
                            </>
                          )}
                        </div>
                      </TabsContent>
                    </Tabs>
                  </div>
                </div>
              </div>
            </ResizablePanel>
          </>
        )}
      </ResizablePanelGroup>

      <AlertDialog open={deleteDialogOpen} onOpenChange={setDeleteDialogOpen}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Delete Payment</AlertDialogTitle>
            <AlertDialogDescription>
              Are you sure you want to delete this payment? This action cannot be undone.
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancel</AlertDialogCancel>
            <AlertDialogAction onClick={confirmDelete} className="bg-red-600 hover:bg-red-700">
              Delete
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  );
}